<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Car Tools</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Favicon -->
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3EðŸš—%3C/text%3E%3C/svg%3E">

<style>
  :root {
    --bg: #e8eff7;
    --card: #ffffff;
    --text: #1a1a1a;
    --muted: #6b7280;
    --accent: #2563eb;
    --border: #d1d5db;
    --radius: 12px;
  }

  body {
    margin: 0;
    font-family: system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    padding: 1rem;
    display: flex;
    justify-content: center;
  }

  .wrap {
    max-width: 860px;
    width: 100%;
  }

  header {
    display: flex;
    align-items: center;
    gap: 0.7rem;
    margin-bottom: 1rem;
  }

  header .logo {
    background: #dbeafe;
    width: 42px;
    height: 42px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
  }

  header h1 {
    margin: 0;
    font-size: 1.4rem;
    letter-spacing: -0.03em;
  }

  .muted {
    font-size: 0.8rem;
    color: var(--muted);
  }

  /* Tabs */
  .tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }

  .tab-btn {
    padding: 0.5rem 1rem;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    background: #fff;
    cursor: pointer;
    font-size: 0.9rem;
  }

  .tab-btn.active {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
  }

  .tab-page {
    display: none;
    background: var(--card);
    padding: 1rem;
    border-radius: var(--radius);
    border: 1px solid var(--border);
  }

  .tab-page.active {
    display: block;
  }

  .field {
    margin-bottom: 0.8rem;
    font-size: 0.9rem;
  }

  .field label {
    display: block;
  }

  input {
    width: 100%;
    padding: 0.45rem 0.6rem;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    margin-top: 0.25rem;
  }

  /* Result boxes */
  .result-box {
    margin-top: 1rem;
    padding: 0.8rem 0.9rem;
    border-radius: 10px;
    background: #eff6ff;
    border: 1px solid #bfdbfe;
  }

  .result-title {
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 0.4rem;
  }

  .result-row {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    gap: 0.75rem;
    margin-top: 0.25rem;
    font-size: 0.95rem;
  }

  .result-row .label {
    color: #4b5563;
  }

  .result-row .value {
    font-weight: 600;
  }
    .small-btn {
    margin-top: 0.35rem;
    padding: 0.35rem 0.75rem;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: #e5f0ff;
    font-size: 0.8rem;
    cursor: pointer;
  }

  .small-btn:hover {
    background: #d0e2ff;
  }
</style>
</head>
<body>

<div class="wrap">

<header>
  <div class="logo">ðŸš—</div>
  <div>
    <h1>Car Tools</h1>
    <div class="muted">Simple tools for EVs & fuel cost comparisons</div>
  </div>
</header>

<!-- Tabs -->
<div class="tabs">
  <button class="tab-btn active" data-tab="step1">Step 1 â€“ How far?</button>
  <button class="tab-btn" data-tab="step2">Step 2 â€“ EV cost</button>
  <button class="tab-btn" data-tab="step3">Step 3 â€“ Petrol vs Diesel</button>
  <button class="tab-btn" data-tab="step4">Step 4 â€“ Charge time</button>
</div>

<!-- STEP 1 -->
<div id="step1" class="tab-page active">
  <h2>Step 1 â€“ How far can my EV go?</h2>
  <p class="muted">This uses the miles on the carâ€™s screen and your battery size to guess how good your efficiency is.</p>

  <div class="field">
    <label>Range on the car (miles)</label>
    <input id="s1_range" type="number" placeholder="e.g. 150">
  </div>

  <div class="field">
    <label>Battery % showing now</label>
    <input id="s1_soc" type="number" placeholder="e.g. 50">
  </div>

  <div class="field">
    <label>Usable battery size (kWh)</label>
    <input id="s1_kwh" type="number" placeholder="e.g. 70">
  </div>

  <div class="result-box">
    <div class="result-title">Result</div>
    <div class="result-row">
      <span class="label">ðŸ”‹ Full battery range estimate:</span>
      <span class="value"><span id="s1_full">â€“</span> miles</span>
    </div>
    <div class="result-row">
      <span class="label">Your efficiency:</span>
      <span class="value"><span id="s1_eff">â€“</span> miles per kWh</span>
    </div>
  </div>
</div>

<!-- STEP 2 -->
<div id="step2" class="tab-page">
  <h2>Step 2 â€“ How much does my EV cost per mile?</h2>
  <p class="muted">We use your miles per kWh and what you pay for electricity. This can come from Step 1.</p>

  <div class="field">
    <label>Miles per kWh</label>
    <input id="s2_eff" type="number" placeholder="e.g. 3.5">
  </div>

  <div class="field">
    <label>Electricity price (p/kWh)</label>
    <input id="s2_ppk" type="number" placeholder="e.g. 22">
  </div>

  <div class="result-box">
    <div class="result-title">Result</div>
    <div class="result-row">
      <span class="label">Per mile:</span>
      <span class="value"><span id="s2_cpm">â€“</span> p</span>
    </div>
    <div class="result-row">
      <span class="label">Per 100 miles:</span>
      <span class="value"><span id="s2_100">â€“</span> Â£</span>
    </div>
  </div>
</div>

<!-- STEP 3 -->
<div id="step3" class="tab-page">
  <h2>Step 3 â€“ What MPG matches my EV cost?</h2>
  <p class="muted">This shows the MPG a petrol or diesel car would need to cost the same per mile as your EV.</p>

  <div class="field">
    <label>Your miles per kWh</label>
    <input id="s3_eff" type="number" placeholder="e.g. 3.5">
  </div>

  <div class="field">
    <label>Your electricity price (p/kWh)</label>
    <input id="s3_ppk" type="number" placeholder="e.g. 22">
  </div>

  <div class="field">
    <label>Petrol price (p per litre)</label>
    <input id="s3_petrol" type="number" placeholder="e.g. 150">
  </div>

 <div class="field">
    <label>Diesel price (p per litre)</label>
    <input id="s3_diesel" type="number" placeholder="e.g. 160">
  </div>

  <div class="field">
    <label>Postcode (optional, for local prices)</label>
    <input id="s3_postcode" type="text" placeholder="e.g. SG1 2BE">
    <button type="button" id="s3_use_local" class="small-btn">Use local supermarket prices</button>
  </div>

  <p class="muted" id="s3_location_note"></p>

  <div class="result-box">
    <div class="result-title">Result</div>
    <div class="result-row">
      <span class="label">Your EV:</span>
      <span class="value"><span id="s3_ev">â€“</span> p per mile</span>
    </div>
    <div class="result-row">
      <span class="label">Petrol car to match:</span>
      <span class="value">
        <span id="s3_petrol_cpm">â€“</span> p per mile Â·
        <span id="s3_petrolmpg">â€“</span> MPG
      </span>
    </div>
    <div class="result-row">
      <span class="label">Diesel car to match:</span>
      <span class="value">
        <span id="s3_diesel_cpm">â€“</span> p per mile Â·
        <span id="s3_dieselmpg">â€“</span> MPG
      </span>
    </div>
  </div>
</div>

<!-- STEP 4 -->
<div id="step4" class="tab-page">
  <h2>Step 4 â€“ How long does charging take?</h2>
  <p class="muted">A simple idea of time based on battery size and charger speed.</p>

  <div class="field">
    <label>Usable battery size (kWh)</label>
    <input id="s4_kwh" type="number" placeholder="e.g. 70">
  </div>

  <div class="field">
    <label>Start %</label>
    <input id="s4_start" type="number" placeholder="e.g. 10">
  </div>

  <div class="field">
    <label>Finish %</label>
    <input id="s4_end" type="number" placeholder="e.g. 80">
  </div>

  <div class="field">
    <label>Charger power (kW)</label>
    <input id="s4_power" type="number" placeholder="e.g. 7.4">
  </div>

  <div class="result-box">
    <div class="result-title">Result</div>
    <div class="result-row">
      <span class="label">Energy added:</span>
      <span class="value"><span id="s4_energy">â€“</span> kWh</span>
    </div>
    <div class="result-row">
      <span class="label">Time needed:</span>
      <span class="value"><span id="s4_time">â€“</span></span>
    </div>
  </div>
</div>

</div>

<script>
/* TAB SWITCHING */
document.querySelectorAll(".tab-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    document.querySelectorAll(".tab-page").forEach(p => p.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById(btn.dataset.tab).classList.add("active");
  });
});

/* STEP 1 */
const s1_range = document.getElementById("s1_range");
const s1_soc   = document.getElementById("s1_soc");
const s1_kwh   = document.getElementById("s1_kwh");
const s1_full  = document.getElementById("s1_full");
const s1_eff   = document.getElementById("s1_eff");

const s2_eff   = document.getElementById("s2_eff");
const s3_eff   = document.getElementById("s3_eff");

function recalcStep1() {
  let r   = parseFloat(s1_range.value);
  let soc = parseFloat(s1_soc.value);
  let kwh = parseFloat(s1_kwh.value);

  if (r > 0 && soc > 0 && kwh > 0) {
    let full = r / (soc / 100);
    let eff  = full / kwh;

    s1_full.textContent = full.toFixed(0);
    s1_eff.textContent  = eff.toFixed(2);

    // Pre-fill later steps with miles per kWh
    s2_eff.value = eff.toFixed(2);
    s3_eff.value = eff.toFixed(2);

    recalcStep2();
    recalcStep3();
  } else {
    s1_full.textContent = "â€“";
    s1_eff.textContent  = "â€“";
  }
}
s1_range.oninput = s1_soc.oninput = s1_kwh.oninput = recalcStep1;

/* STEP 2 */
const s2_ppk  = document.getElementById("s2_ppk");
const s2_cpm  = document.getElementById("s2_cpm");
const s2_100  = document.getElementById("s2_100");
const s3_ppk  = document.getElementById("s3_ppk");

function recalcStep2() {
  let eff = parseFloat(s2_eff.value);
  let ppk = parseFloat(s2_ppk.value);

  if (eff > 0 && ppk > 0) {
    let cost = ppk / eff;  // pence per mile
    s2_cpm.textContent = cost.toFixed(1);

    // For 100 miles: same number in Â£ (100 miles * p/mile / 100 p/Â£)
    s2_100.textContent = cost.toFixed(2);

    // Pre-fill Step 3 electricity price
    s3_ppk.value = ppk.toString();
    recalcStep3();
  } else {
    s2_cpm.textContent = "â€“";
    s2_100.textContent = "â€“";
  }
}
s2_eff.oninput = s2_ppk.oninput = recalcStep2;

/* STEP 3 */
const s3_petrol       = document.getElementById("s3_petrol");
const s3_diesel       = document.getElementById("s3_diesel");
const s3_ev           = document.getElementById("s3_ev");
const s3_petrol_cpm   = document.getElementById("s3_petrol_cpm");
const s3_diesel_cpm   = document.getElementById("s3_diesel_cpm");
const s3_petrolmpg    = document.getElementById("s3_petrolmpg");
const s3_dieselmpg    = document.getElementById("s3_dieselmpg");
const s3_postcode     = document.getElementById("s3_postcode");
const s3_use_local    = document.getElementById("s3_use_local");
const s3_location_note= document.getElementById("s3_location_note");

// will hold all supermarket stations and last updated from proxy
let fuelStations = null;
let fuelLastUpdated = null;

function recalcStep3() {
  let eff = parseFloat(s3_eff.value);
  let ppk = parseFloat(s3_ppk.value);
  let pet = parseFloat(s3_petrol.value);
  let dis = parseFloat(s3_diesel.value);

  if (eff > 0 && ppk > 0) {
    let evCost = ppk / eff;  // pence per mile

    s3_ev.textContent         = evCost.toFixed(1);
    s3_petrol_cpm.textContent = evCost.toFixed(1);
    s3_diesel_cpm.textContent = evCost.toFixed(1);

    const gal = 4.546;

    if (pet > 0) {
      s3_petrolmpg.textContent = ((pet * gal) / evCost).toFixed(1);
    } else {
      s3_petrolmpg.textContent = "â€“";
    }

    if (dis > 0) {
      s3_dieselmpg.textContent = ((dis * gal) / evCost).toFixed(1);
    } else {
      s3_dieselmpg.textContent = "â€“";
    }
  } else {
    s3_ev.textContent         = "â€“";
    s3_petrol_cpm.textContent = "â€“";
    s3_diesel_cpm.textContent = "â€“";
    s3_petrolmpg.textContent  = "â€“";
    s3_dieselmpg.textContent  = "â€“";
  }
}
s3_eff.oninput = s3_ppk.oninput = s3_petrol.oninput = s3_diesel.oninput = recalcStep3;

// helper: compute averages from an array of stations using E10/E5 for petrol and B7 for diesel
function computeFuelAveragesFromStations(stations) {
  const petrolPrices = [];
  const dieselPrices = [];

  for (const st of stations) {
    const prices = st.prices || {};
    if (typeof prices.E10 === "number") {
      petrolPrices.push(prices.E10);
    } else if (typeof prices.E5 === "number") {
      petrolPrices.push(prices.E5);
    }
    if (typeof prices.B7 === "number") {
      dieselPrices.push(prices.B7);
    }
  }

  const avg = arr =>
    arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : null;

  return {
    petrolAvg: petrolPrices.length ? avg(petrolPrices) : null,
    dieselAvg: dieselPrices.length ? avg(dieselPrices) : null
  };
}

// --- Auto-fill petrol & diesel from Cloudflare fuel proxy ---
async function autoFillFuelFromProxy() {
  try {
    const res = await fetch("https://fuel-proxy.7hunto91.workers.dev");
    if (!res.ok) {
      console.warn("Fuel proxy HTTP error", res.status);
      return;
    }

    const data = await res.json();

    // Expected shape from worker: { last_updated, stations: [...] }
    const stations = Array.isArray(data.stations) ? data.stations : [];
    if (!stations.length) {
      console.warn("No stations in fuel data", data);
      return;
    }

    fuelStations = stations;
    fuelLastUpdated = data.last_updated || data.lastUpdated || null;

    const { petrolAvg, dieselAvg } = computeFuelAveragesFromStations(stations);

    if (!petrolAvg && !dieselAvg) {
      console.warn("No usable fuel prices found in stations");
      return;
    }

    if (petrolAvg) {
      s3_petrol.value = petrolAvg.toFixed(1);   // pence per litre
      console.log("Petrol avg (p/L):", petrolAvg);
    }
    if (dieselAvg) {
      s3_diesel.value = dieselAvg.toFixed(1);
      console.log("Diesel avg (p/L):", dieselAvg);
    }

    if (s3_location_note) {
      const updatedText = fuelLastUpdated ? `Last updated ${fuelLastUpdated}.` : "";
      s3_location_note.textContent = `Using national supermarket average prices. ${updatedText}`;
    }

    recalcStep3();
  } catch (err) {
    console.error("Fuel proxy fetch failed", err);
  }
}

// use postcode outward code to average nearby stations
function applyFuelForPostcode() {
  if (!fuelStations || !fuelStations.length) {
    console.warn("No fuel stations loaded yet");
    return;
  }

  const raw = s3_postcode.value.trim().toUpperCase();
  if (!raw) {
    // if no postcode, go back to national average
    autoFillFuelFromProxy();
    return;
  }

  // Outward code = everything up to first space, no spaces, e.g. "SG1"
  const cleaned = raw.replace(/\s+/g, "");
  const match = cleaned.match(/^[A-Z0-9]+/);
  if (!match) {
    console.warn("Could not understand postcode", raw);
    return;
  }
  const outward = match[0];

  const localStations = fuelStations.filter(st => {
    if (!st.postcode) return false;
    const pc = String(st.postcode).toUpperCase().replace(/\s+/g, "");
    return pc.startsWith(outward);
  });

  const sourceStations = localStations.length ? localStations : fuelStations;
  const { petrolAvg, dieselAvg } = computeFuelAveragesFromStations(sourceStations);

  if (petrolAvg) {
    s3_petrol.value = petrolAvg.toFixed(1);
  }
  if (dieselAvg) {
    s3_diesel.value = dieselAvg.toFixed(1);
  }
  recalcStep3();

  if (s3_location_note) {
    if (localStations.length) {
      s3_location_note.textContent =
        `Using average prices for ${outward} area from ${localStations.length} nearby supermarket stations.`;
    } else {
      s3_location_note.textContent =
        `Could not find local stations for ${raw}. Showing national supermarket average instead.`;
    }
  }
}

if (s3_use_local) {
  s3_use_local.addEventListener("click", applyFuelForPostcode);
}

// run once page is ready
window.addEventListener("DOMContentLoaded", autoFillFuelFromProxy);


/* STEP 4 */
const s4_kwh    = document.getElementById("s4_kwh");
const s4_start  = document.getElementById("s4_start");
const s4_end    = document.getElementById("s4_end");
const s4_power  = document.getElementById("s4_power");
const s4_energy = document.getElementById("s4_energy");
const s4_time   = document.getElementById("s4_time");

function recalcStep4() {
  let k  = parseFloat(s4_kwh.value);
  let st = parseFloat(s4_start.value);
  let en = parseFloat(s4_end.value);
  let p  = parseFloat(s4_power.value);

  if (k > 0 && st >= 0 && en > st && p > 0) {
    let energy = k * ((en - st) / 100);
    s4_energy.textContent = energy.toFixed(1);

    let hours = energy / p;
    let h = Math.floor(hours);
    let m = Math.round((hours - h) * 60);

    s4_time.textContent = `${h}h ${m}m`;
  } else {
    s4_energy.textContent = "â€“";
    s4_time.textContent   = "â€“";
  }
}
s4_kwh.oninput = s4_start.oninput = s4_end.oninput = s4_power.oninput = recalcStep4;
</script>

  <div style="text-align:center; padding:1rem; font-size:0.8rem; color:#6b7280;">
  Â© 2025 Car Tools Project Â· All Rights Reserved
</div>

</body>
</html>




