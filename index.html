<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Car Tools</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Favicon -->
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3Eüöó%3C/text%3E%3C/svg%3E">

<style>
  :root {
    --bg: #e8eff7;
    --card: #ffffff;
    --text: #1a1a1a;
    --muted: #6b7280;
    --accent: #2563eb;
    --border: #d1d5db;
    --radius: 12px;
  }

  *, *::before, *::after {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    font-family: system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    padding: 1rem;
  }

  .wrap {
    max-width: 860px;
    width: 100%;
    margin: 0 auto;
  }

  header {
    display: flex;
    align-items: center;
    gap: 0.7rem;
    margin-bottom: 1rem;
  }

  header .logo {
    background: #dbeafe;
    width: 42px;
    height: 42px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
  }

  header h1 {
    margin: 0;
    font-size: 1.4rem;
    letter-spacing: -0.03em;
  }

  .muted {
    font-size: 0.8rem;
    color: var(--muted);
  }

  /* Tabs */
  .tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }

  .tab-btn {
    padding: 0.5rem 1rem;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    background: #fff;
    cursor: pointer;
    font-size: 0.9rem;
  }

  .tab-btn.active {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
  }

  .tab-page {
    display: none;
    background: var(--card);
    padding: 1rem 1.4rem 1.4rem;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    overflow: hidden;
  }

  .tab-page.active {
    display: block;
  }

  .field {
    margin-bottom: 0.8rem;
    font-size: 0.9rem;
  }

  .field label {
    display: block;
  }

  input, select {
    width: 100%;
    padding: 0.45rem 0.6rem;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    margin-top: 0.25rem;
    font-size: 0.9rem;
  }

  .result-box {
    margin-top: 1rem;
    padding: 0.8rem 0.9rem;
    border-radius: 10px;
    background: #eff6ff;
    border: 1px solid #bfdbfe;
    width: 100%;
  }

  .result-title {
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 0.4rem;
  }

  .result-row {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    gap: 0.75rem;
    margin-top: 0.25rem;
    font-size: 0.95rem;
  }

  .result-row .label {
    color: #4b5563;
  }

  .result-row .value {
    font-weight: 600;
  }

  .small-btn {
    margin-top: 0.35rem;
    padding: 0.55rem 0.9rem;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: #e5f0ff;
    font-size: 0.85rem;
    cursor: pointer;
  }

  .small-btn:hover {
    background: #d0e2ff;
  }

  .primary-btn {
    margin-top: 0.6rem;
    padding: 0.65rem 1.4rem;
    border-radius: 999px;
    border: none;
    background: var(--accent);
    color: #ffffff;
    font-size: 0.9rem;
    cursor: pointer;
    font-weight: 600;
  }

  .primary-btn:hover {
    filter: brightness(0.95);
  }

  .preset-row {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.4rem;
    font-size: 0.8rem;
  }

  .preset-btn.active {
    background: var(--accent);
    color: #ffffff;
    border-color: var(--accent);
  }

  .footer {
    width: 100%;
    text-align: center;
    padding: 1rem 0 0.5rem;
    font-size: 0.8rem;
    color: #6b7280;
  }

  @media (max-width: 640px) {
    header {
      align-items: flex-start;
    }
    .tab-page {
      padding: 0.9rem 1rem 1.2rem;
    }
  }
</style>
</head>
<body>

<div class="wrap">

<header>
  <div class="logo">üöó</div>
  <div>
    <h1>Car Tools</h1>
    <div class="muted">Simple tools for EVs & fuel cost comparisons</div>
  </div>
</header>

<div class="tabs">
  <button class="tab-btn active" data-tab="step1">Step 1 ‚Äì How far?</button>
  <button class="tab-btn" data-tab="step2">Step 2 ‚Äì EV cost</button>
  <button class="tab-btn" data-tab="step3">Step 3 ‚Äì EV vs petrol and Diesel</button>
  <button class="tab-btn" data-tab="step4">Step 4 ‚Äì Running cost</button>
  <button class="tab-btn" data-tab="step5">Step 5 ‚Äì Charge time</button>
</div>

<!-- STEP 1 -->
<div id="step1" class="tab-page active">
  <h2>Step 1 ‚Äì How far can my EV go?</h2>
  <p class="muted">This uses the miles on the car‚Äôs screen and your battery size to guess how good your efficiency is.</p>

  <div class="field">
    <label>Range on the car (miles)</label>
    <input id="s1_range" type="number" placeholder="e.g. 150">
  </div>

  <div class="field">
    <label>Battery % showing now</label>
    <input id="s1_soc" type="number" placeholder="e.g. 50">
  </div>

  <div class="field">
    <label>Usable battery size (kWh)</label>
    <input id="s1_kwh" type="number" placeholder="e.g. 70">
  </div>

  <div class="result-box">
    <div class="result-title">Result</div>
    <div class="result-row">
      <span class="label">üîã Full battery range estimate:</span>
      <span class="value"><span id="s1_full">‚Äì</span> miles</span>
    </div>
    <div class="result-row">
      <span class="label">Your efficiency:</span>
      <span class="value"><span id="s1_eff">‚Äì</span> miles per kWh</span>
    </div>
  </div>
</div>

<!-- STEP 2 -->
<div id="step2" class="tab-page">
  <h2>Step 2 ‚Äì How much does my EV cost per mile?</h2>
  <p class="muted">
    We use your miles per kWh and what you pay for electricity. We‚Äôve pre-filled a typical home tariff,
    but you can edit it to match your own bill or use the quick presets.
  </p>

  <div class="field">
    <label>Miles per kWh</label>
    <input id="s2_eff" type="number" placeholder="e.g. 3.5">
  </div>

  <div class="field">
    <label>Electricity price (p/kWh)</label>
    <input id="s2_ppk" type="number" placeholder="e.g. 22">
    <div class="preset-row">
      <button type="button" class="small-btn preset-btn" data-ppk-preset="22">üè† Home (22p)</button>
      <button type="button" class="small-btn preset-btn" data-ppk-preset="55">‚ö° Public rapid (55p)</button>
      <button type="button" class="small-btn preset-btn" data-ppk-preset="75">üöÄ Ultra-rapid (75p)</button>
    </div>
  </div>

  <div class="result-box">
    <div class="result-title">Result</div>
    <div class="result-row">
      <span class="label">Per mile:</span>
      <span class="value"><span id="s2_cpm">‚Äì</span> p</span>
    </div>
    <div class="result-row">
      <span class="label">Per 100 miles:</span>
      <span class="value"><span id="s2_100">‚Äì</span> ¬£</span>
    </div>
  </div>
</div>

<!-- STEP 3 -->
<div id="step3" class="tab-page">
  <h2>Step 3 ‚Äì EV vs petrol and Diesel</h2>
  <p class="muted">This shows the MPG a petrol or diesel car would need to match your EV‚Äôs cost per mile.</p>

  <div class="field">
    <label>Your miles per kWh</label>
    <input id="s3_eff" type="number" placeholder="e.g. 3.5">
  </div>

  <div class="field">
    <label>Your electricity price (p/kWh)</label>
    <input id="s3_ppk" type="number" placeholder="e.g. 22">
  </div>

  <div class="field">
    <label>Petrol price (p per litre)</label>
    <input id="s3_petrol" type="number" placeholder="e.g. 150">
  </div>

  <div class="field">
    <label>Diesel price (p per litre)</label>
    <input id="s3_diesel" type="number" placeholder="e.g. 160">
  </div>

  <div class="field">
    <label>Postcode (optional, for local prices)</label>
    <input id="s3_postcode" type="text" placeholder="e.g. SG1 2BE">
    <button type="button" id="s3_use_local" class="small-btn">Use local supermarket prices</button>
  </div>

  <p class="muted" id="s3_location_note"></p>

  <div class="result-box">
    <div class="result-title">Result</div>
    <div class="result-row">
      <span class="label">Your EV:</span>
      <span class="value"><span id="s3_ev">‚Äì</span> p per mile</span>
    </div>
    <div class="result-row">
      <span class="label">Petrol car to match:</span>
      <span class="value">
        <span id="s3_petrol_cpm">‚Äì</span> p per mile ¬∑
        <span id="s3_petrolmpg">‚Äì</span> MPG
      </span>
    </div>
    <div class="result-row">
      <span class="label">Diesel car to match:</span>
      <span class="value">
        <span id="s3_diesel_cpm">‚Äì</span> p per mile ¬∑
        <span id="s3_dieselmpg">‚Äì</span> MPG
      </span>
    </div>
  </div>
</div>

<!-- STEP 4 ‚Äì Running cost -->
<div id="step4" class="tab-page">
  <h2>Step 4 ‚Äì Running cost</h2>
  <p class="muted">
    This compares the running cost of your EV with a petrol or diesel car, based on your monthly mileage.
  </p>

  <div class="field">
    <label>Your miles per month</label>
    <input id="s4_mpm" type="number" placeholder="e.g. 800">
  </div>

  <div class="field">
    <label>Fuel type for comparison</label>
    <select id="s4_fueltype">
      <option value="petrol">Petrol</option>
      <option value="diesel">Diesel</option>
    </select>
  </div>

  <div class="field">
    <label>Vehicle size</label>
    <select id="s4_vehiclesize">
      <option value="small_hatch">Small hatchback (Fiesta / Corsa)</option>
      <option value="med_hatch">Medium hatchback (Golf / Focus / A3)</option>
      <option value="small_suv">Small SUV (Puma / Juke)</option>
      <option value="med_suv">Medium SUV (Kuga / Qashqai / Tiguan)</option>
      <option value="large_suv">Large SUV (Kodiaq / Sportage / Tucson)</option>
    </select>
  </div>

  <button type="button" id="s4_use_mpg" class="primary-btn">Use MPG</button>
  <p class="muted" id="s4_hint">
    Uses your electricity and fuel prices from Steps 2 &amp; 3.
  </p>

  <div class="result-box">
    <div class="result-title">Result (per month)</div>

    <div class="result-row">
      <span class="label">Your EV running cost:</span>
      <span class="value">
        <span id="s4_ev_month">‚Äì</span>
      </span>
    </div>

    <div class="result-row">
      <span class="label"><span id="s4_ice_label">Petrol/Diesel</span> running cost:</span>
      <span class="value">
        <span id="s4_ice_month">‚Äì</span>
      </span>
    </div>
  </div>
</div>

<!-- STEP 5 ‚Äì Charge time -->
<div id="step5" class="tab-page">
  <h2>Step 5 ‚Äì How long does charging take?</h2>
  <p class="muted">A simple idea of time based on battery size and charger speed.</p>

  <div class="field">
    <label>Usable battery size (kWh)</label>
    <input id="s5_kwh" type="number" placeholder="e.g. 70">
  </div>

  <div class="field">
    <label>Start %</label>
    <input id="s5_start" type="number" placeholder="e.g. 10">
  </div>

  <div class="field">
    <label>Finish %</label>
    <input id="s5_end" type="number" placeholder="e.g. 80">
  </div>

  <div class="field">
    <label>Charger power (kW)</label>
    <input id="s5_power" type="number" placeholder="e.g. 7.4">
  </div>

  <div class="result-box">
    <div class="result-title">Result</div>
    <div class="result-row">
      <span class="label">Energy added:</span>
      <span class="value"><span id="s5_energy">‚Äì</span> kWh</span>
    </div>
    <div class="result-row">
      <span class="label">Time needed:</span>
      <span class="value"><span id="s5_time">‚Äì</span></span>
    </div>
  </div>
</div>

</div><!-- /.wrap -->

<div class="footer">
  ¬© 2025 Car Tools Project ¬∑ All Rights Reserved
</div>

<script>
const DEFAULT_ELEC_PPK = 22;

/* TAB SWITCHING */
document.querySelectorAll(".tab-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    document.querySelectorAll(".tab-page").forEach(p => p.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById(btn.dataset.tab).classList.add("active");
  });
});

/* STEP 1 */
const s1_range = document.getElementById("s1_range");
const s1_soc   = document.getElementById("s1_soc");
const s1_kwh   = document.getElementById("s1_kwh");
const s1_full  = document.getElementById("s1_full");
const s1_eff   = document.getElementById("s1_eff");

const s2_eff   = document.getElementById("s2_eff");
const s3_eff   = document.getElementById("s3_eff");

function recalcStep1() {
  let r   = parseFloat(s1_range.value);
  let soc = parseFloat(s1_soc.value);
  let kwh = parseFloat(s1_kwh.value);

  if (r > 0 && soc > 0 && kwh > 0) {
    let full = r / (soc / 100);
    let eff  = full / kwh;

    s1_full.textContent = full.toFixed(0);
    s1_eff.textContent  = eff.toFixed(2);

    s2_eff.value = eff.toFixed(2);
    s3_eff.value = eff.toFixed(2);

    recalcStep2();
    recalcStep3();
  } else {
    s1_full.textContent = "‚Äì";
    s1_eff.textContent  = "‚Äì";
  }
}
s1_range.oninput = s1_soc.oninput = s1_kwh.oninput = recalcStep1;

/* STEP 2 */
const s2_ppk  = document.getElementById("s2_ppk");
const s2_cpm  = document.getElementById("s2_cpm");
const s2_100  = document.getElementById("s2_100");
const s3_ppk  = document.getElementById("s3_ppk");

function recalcStep2() {
  let eff = parseFloat(s2_eff.value);
  let ppk = parseFloat(s2_ppk.value);

  if (eff > 0 && ppk > 0) {
    let cost = ppk / eff;
    s2_cpm.textContent = cost.toFixed(1);
    s2_100.textContent = cost.toFixed(2);

    s3_ppk.value = ppk.toString();
    recalcStep3();
  } else {
    s2_cpm.textContent = "‚Äì";
    s2_100.textContent = "‚Äì";
  }
}
s2_eff.oninput = s2_ppk.oninput = recalcStep2;

const presetButtons = document.querySelectorAll("[data-ppk-preset]");
function handlePresetClick(e) {
  const btn = e.currentTarget;
  const value = parseFloat(btn.dataset.ppkPreset);
  if (!isNaN(value)) {
    s2_ppk.value = value;
    presetButtons.forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    recalcStep2();
  }
}
presetButtons.forEach(btn => btn.addEventListener("click", handlePresetClick));

/* STEP 3 */
const s3_petrol       = document.getElementById("s3_petrol");
const s3_diesel       = document.getElementById("s3_diesel");
const s3_ev           = document.getElementById("s3_ev");
const s3_petrol_cpm   = document.getElementById("s3_petrol_cpm");
const s3_diesel_cpm   = document.getElementById("s3_diesel_cpm");
const s3_petrolmpg    = document.getElementById("s3_petrolmpg");
const s3_dieselmpg    = document.getElementById("s3_dieselmpg");
const s3_postcode     = document.getElementById("s3_postcode");
const s3_use_local    = document.getElementById("s3_use_local");
const s3_location_note= document.getElementById("s3_location_note");

let fuelStations = null;
let fuelLastUpdated = null;

function recalcStep3() {
  let eff = parseFloat(s3_eff.value);
  let ppk = parseFloat(s3_ppk.value);
  let pet = parseFloat(s3_petrol.value);
  let dis = parseFloat(s3_diesel.value);

  if (eff > 0 && ppk > 0) {
    let evCost = ppk / eff;

    s3_ev.textContent         = evCost.toFixed(1);
    s3_petrol_cpm.textContent = evCost.toFixed(1);
    s3_diesel_cpm.textContent = evCost.toFixed(1);

    const gal = 4.546;
    if (pet > 0) {
      s3_petrolmpg.textContent = ((pet * gal) / evCost).toFixed(1);
    } else {
      s3_petrolmpg.textContent = "‚Äì";
    }
    if (dis > 0) {
      s3_dieselmpg.textContent = ((dis * gal) / evCost).toFixed(1);
    } else {
      s3_dieselmpg.textContent = "‚Äì";
    }
  } else {
    s3_ev.textContent         = "‚Äì";
    s3_petrol_cpm.textContent = "‚Äì";
    s3_diesel_cpm.textContent = "‚Äì";
    s3_petrolmpg.textContent  = "‚Äì";
    s3_dieselmpg.textContent  = "‚Äì";
  }

  recalcStep4();
}
s3_eff.oninput = s3_ppk.oninput = s3_petrol.oninput = s3_diesel.oninput = recalcStep3;

function computeFuelAveragesFromStations(stations) {
  const petrolPrices = [];
  const dieselPrices = [];

  for (const st of stations) {
    const prices = st.prices || {};
    if (typeof prices.E10 === "number") {
      petrolPrices.push(prices.E10);
    } else if (typeof prices.E5 === "number") {
      petrolPrices.push(prices.E5);
    }
    if (typeof prices.B7 === "number") {
      dieselPrices.push(prices.B7);
    }
  }

  const avg = arr => arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : null;
  return {
    petrolAvg: petrolPrices.length ? avg(petrolPrices) : null,
    dieselAvg: dieselPrices.length ? avg(dieselPrices) : null
  };
}

async function autoFillFuelFromProxy() {
  try {
    const res = await fetch("https://fuel-proxy.7hunto91.workers.dev");
    if (!res.ok) {
      console.warn("Fuel proxy HTTP error", res.status);
      return;
    }
    const data = await res.json();
    const stations = Array.isArray(data.stations) ? data.stations : [];
    if (!stations.length) {
      console.warn("No stations in fuel data", data);
      return;
    }

    fuelStations = stations;
    fuelLastUpdated = data.last_updated || data.lastUpdated || null;

    const { petrolAvg, dieselAvg } = computeFuelAveragesFromStations(stations);
    if (!petrolAvg && !dieselAvg) {
      console.warn("No usable fuel prices found in stations");
      return;
    }
    if (petrolAvg) s3_petrol.value = petrolAvg.toFixed(1);
    if (dieselAvg) s3_diesel.value = dieselAvg.toFixed(1);

    if (s3_location_note) {
      const updatedText = fuelLastUpdated ? `Last updated ${fuelLastUpdated}.` : "";
      s3_location_note.textContent = `Using national supermarket average prices. ${updatedText}`;
    }
    recalcStep3();
  } catch (err) {
    console.error("Fuel proxy fetch failed", err);
  }
}

function applyFuelForPostcode() {
  if (!fuelStations || !fuelStations.length) {
    console.warn("No fuel stations loaded yet");
    return;
  }

  const raw = s3_postcode.value.trim().toUpperCase();
  if (!raw) {
    autoFillFuelFromProxy();
    return;
  }

  const outwardUser = raw.split(/\s+/)[0];
  const areaMatch = outwardUser.match(/^[A-Z]{1,2}/);
  const areaUser  = areaMatch ? areaMatch[0] : null;

  const getOutward = pc => String(pc).toUpperCase().trim().split(/\s+/)[0];

  let localStations = fuelStations.filter(st => {
    if (!st.postcode) return false;
    return getOutward(st.postcode) === outwardUser;
  });

  let usedMode = "outward";
  if (!localStations.length && areaUser) {
    localStations = fuelStations.filter(st => {
      if (!st.postcode) return false;
      const stOutward = getOutward(st.postcode);
      return stOutward.startsWith(areaUser);
    });
    usedMode = "area";
  }

  const sourceStations = localStations.length ? localStations : fuelStations;
  const { petrolAvg, dieselAvg } = computeFuelAveragesFromStations(sourceStations);

  if (petrolAvg) s3_petrol.value = petrolAvg.toFixed(1);
  if (dieselAvg) s3_diesel.value = dieselAvg.toFixed(1);
  recalcStep3();

  if (!s3_location_note) return;

  if (localStations.length && usedMode === "outward") {
    s3_location_note.textContent =
      `Using average prices for ${outwardUser} area from ${localStations.length} nearby supermarket stations.`;
  } else if (localStations.length && usedMode === "area") {
    s3_location_note.textContent =
      `No stations found specifically in ${outwardUser}. Using average prices across the ${areaUser} postcode area from ${localStations.length} supermarket stations.`;
  } else {
    s3_location_note.textContent =
      `Could not find local supermarket stations for ${raw}. Showing national supermarket average instead.`;
  }
}
if (s3_use_local) {
  s3_use_local.addEventListener("click", applyFuelForPostcode);
}

/* STEP 4 ‚Äì Running cost */
const s4_mpm        = document.getElementById("s4_mpm");
const s4_fueltype   = document.getElementById("s4_fueltype");
const s4_vehiclesize= document.getElementById("s4_vehiclesize");
const s4_use_mpg    = document.getElementById("s4_use_mpg");
const s4_hint       = document.getElementById("s4_hint");
const s4_ev_month   = document.getElementById("s4_ev_month");
const s4_ice_month  = document.getElementById("s4_ice_month");
const s4_ice_label  = document.getElementById("s4_ice_label");

let s4_currentMpg = null;

const MPG_PRESETS = {
  petrol: {
    small_hatch: 45,
    med_hatch:   41,
    small_suv:   38,
    med_suv:     35,
    large_suv:   30
  },
  diesel: {
    small_hatch: 60,
    med_hatch:   55,
    small_suv:   50,
    med_suv:     46,
    large_suv:   42
  }
};

function getEvCostPerMile() {
  let eff = parseFloat(s3_eff.value) || parseFloat(s2_eff.value);
  let ppk = parseFloat(s3_ppk.value) || parseFloat(s2_ppk.value);
  if (eff > 0 && ppk > 0) return ppk / eff;
  return null;
}

function costPerMileFromMPG(pencePerLitre, mpg) {
  const gal = 4.546;
  if (!(pencePerLitre > 0 && mpg > 0)) return null;
  const pencePerGallon = pencePerLitre * gal;
  return pencePerGallon / mpg;
}

function recalcStep4() {
  let mpm = parseFloat(s4_mpm.value);
  if (!(mpm > 0)) {
    s4_ev_month.textContent  = "‚Äì";
    s4_ice_month.textContent = "‚Äì";
    return;
  }

  const evCpm = getEvCostPerMile();
  if (!evCpm || !(evCpm > 0)) {
    s4_ev_month.textContent = "‚Äì";
  } else {
    const evMonth = (mpm * evCpm) / 100;
    s4_ev_month.textContent = "¬£" + evMonth.toFixed(2);
  }

  const fuel = s4_fueltype.value || "petrol";
  const label = fuel === "diesel" ? "Diesel" : "Petrol";
  s4_ice_label.textContent = label;

  const pricePerLitre = fuel === "diesel"
    ? parseFloat(s3_diesel.value)
    : parseFloat(s3_petrol.value);

  const mpg = s4_currentMpg;
  const iceCpm = costPerMileFromMPG(pricePerLitre, mpg);

  if (!iceCpm || !(iceCpm > 0)) {
    s4_ice_month.textContent = "‚Äì";
    return;
  }
  const iceMonth = (mpm * iceCpm) / 100;
  s4_ice_month.textContent = "¬£" + iceMonth.toFixed(2);
}

if (s4_use_mpg) {
  s4_use_mpg.addEventListener("click", () => {
    const fuel = s4_fueltype.value || "petrol";
    const size = s4_vehiclesize.value || "med_hatch";
    const fuelPresets = MPG_PRESETS[fuel] || MPG_PRESETS.petrol;
    const mpg = fuelPresets[size];
    if (!mpg) {
      s4_currentMpg = null;
      if (s4_hint) s4_hint.textContent = "No MPG preset for that combination yet.";
      recalcStep4();
      return;
    }
    s4_currentMpg = mpg;
    if (s4_hint) {
      let sizeLabel;
      switch (size) {
        case "small_hatch": sizeLabel = "small hatchback"; break;
        case "med_hatch":   sizeLabel = "medium hatchback"; break;
        case "small_suv":   sizeLabel = "small SUV"; break;
        case "med_suv":     sizeLabel = "medium SUV"; break;
        case "large_suv":   sizeLabel = "large SUV"; break;
        default: sizeLabel = "car";
      }
      const fuelLabel = fuel === "diesel" ? "diesel" : "petrol";
      s4_hint.textContent =
        `Using about ${mpg.toFixed(0)} MPG for a ${sizeLabel} ${fuelLabel}.`;
    }
    recalcStep4();
  });
}

if (s4_mpm) {
  s4_mpm.oninput = recalcStep4;
}
if (s4_fueltype) {
  s4_fueltype.onchange = () => {
    s4_currentMpg = null;
    if (s4_hint) s4_hint.textContent = "Tap ‚ÄúUse MPG‚Äù to refresh the estimate for this fuel type.";
    recalcStep4();
  };
}
if (s4_vehiclesize) {
  s4_vehiclesize.onchange = () => {
    s4_currentMpg = null;
    if (s4_hint) s4_hint.textContent = "Tap ‚ÄúUse MPG‚Äù to refresh the estimate for this size.";
    recalcStep4();
  };
}

/* STEP 5 ‚Äì Charge time */
const s5_kwh    = document.getElementById("s5_kwh");
const s5_start  = document.getElementById("s5_start");
const s5_end    = document.getElementById("s5_end");
const s5_power  = document.getElementById("s5_power");
const s5_energy = document.getElementById("s5_energy");
const s5_time   = document.getElementById("s5_time");

function recalcStep5() {
  let k  = parseFloat(s5_kwh.value);
  let st = parseFloat(s5_start.value);
  let en = parseFloat(s5_end.value);
  let p  = parseFloat(s5_power.value);

  if (k > 0 && st >= 0 && en > st && p > 0) {
    let energy = k * ((en - st) / 100);
    s5_energy.textContent = energy.toFixed(1);

    let hours = energy / p;
    let h = Math.floor(hours);
    let m = Math.round((hours - h) * 60);
    s5_time.textContent = `${h}h ${m}m`;
  } else {
    s5_energy.textContent = "‚Äì";
    s5_time.textContent   = "‚Äì";
  }
}
s5_kwh.oninput = s5_start.oninput = s5_end.oninput = s5_power.oninput = recalcStep5;

/* On load */
window.addEventListener("DOMContentLoaded", () => {
  if (!s2_ppk.value) {
    s2_ppk.value = DEFAULT_ELEC_PPK;
  }
  presetButtons.forEach(btn => {
    if (btn.dataset.ppkPreset === String(DEFAULT_ELEC_PPK)) {
      btn.classList.add("active");
    }
  });
  recalcStep2();
  autoFillFuelFromProxy();
});
</script>

</body>
</html>
